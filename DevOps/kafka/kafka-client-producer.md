# 카프카-클라이언트 프로듀서 API

* 참고글 https://always-kimkim.tistory.com/entry/kafka101-producer

#### 카프카 프로듀서의 개념
* 프로듀서란 보통 카프카 프로듀서 API와 그것으로 구성된 애플리케이션을 말한다.
* 프로듀서는 broker에 특정 topic을 지정하여 메시지를 전달하는 역할을 담당한다.


#### 카프카 프로듀서 메시지 구조
* producer를 통해 전달되는 메시지 구조는 다음과 같다.
    * 토픽
    * 토픽 중 특정 파티션 위치
    * 메시지 생성 기간
    * 메시지 키
    * 메시지 값

#### 프로듀서 구조와 메시지 전달 과정
* producer가 broker에 메시지를 전달하는 과정 요약
    1. 직렬화 serializer
    2. 파티셔닝 partitioner
    3. 압축 compression
    4. 메시지 배치 record batch
    5. 전달 sender

* 과정 상세
    1. 직렬화 serializer
        - 프로듀서는 먼저 전달 요청받은 메시지를 직렬화한다. 직렬화 과정을 통해 메시지의 키와 값은 바이트 뭉치 형태로 변환된다.
    2. 파티셔닝 partitioning
        - 직렬화 과정을 마친 메시지는 Partitioner를 통해 토픽의 어떤 파티션에 저장될지 결정된다.
        - 이 때 파티션이 따로 지정되지 않으면 Round Robbin 형태로 파티션들에게 골고루 전달된다.
    3. 압축 compression
        - 카프카가 지원하는 압축 포맷 중 설정된 포맷으로 메시지 압축을 진행한다.
    4. 메시지 배치 record batch
        - 파티셔닝과 압축을 마친 메시지는 TCP 프로토콜을 통해 브로커 리더 파티션으로 전송된다. 
    5. 전달 sender
        - sender라는 스레드가 배치 큐에 저장된 레코드 배치들을 브로커에 전달한다.
        - 이 때 관리자가 설정한 특정 조건을 만족해야 전송되어야 하지만 네트워크 비용을 줄이기 위해 조건을 만족하지 않은 다른 레코드 배치들도 piggyback 방식으로 함께 전달한다.(* piggyback: 등 뒤에 업는다는 뜻)
        - sender는 설정값에 따라 브로커의 응답을 기다리거나 기다리지 않을 수 있다.
        - 응답을 기다리지 않는 경우, 메시지 전송 후 과정이 종료된다.
        - 만약 응답을 기다리는 경우, 메시지 전송 성공 여불르 응답으로 받는다. 전송이 실패한 경우 또다시 설정값에 따라 재시도를 할 수 있다. 성공한 경우에는 저장된 정보(메타데이터)를 반환한다.
        - 메타데이터는 메시지가 저장된 토픽, 파티션, 오프셋, 타임스탬프 정보를 갖는다.



