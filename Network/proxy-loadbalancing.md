# 프록시 proxy

## 프록시 서버란?
- 클라이언트가 자신을 통해서 다른 네트워크 서비스에 간접적으로 접속할 수 있게 해주는 컴퓨터 시스템이나 응용 프로그램
- 즉, 서버와 클라이언트 사이에서 중계 서버로서 대리로 통신을 수행
- A클라이언트가 B프록시에 접근하여 C서버에 접속하는 방식

## 프록시 서버를 사용하는 이유
- 보안성
    - 서버를 우회하여 익명으로 컴퓨터를 유지, IP 추적 등을 회피
    - 네트워크 서비스나 콘텐츠로의 접근 정책을 적용, 외부로 나가는 콘텐츠를 기록하고 검사
- 효율성
    - 프록시 서버에 저장된 캐시로 외부요청을 처리

## 프록시의 종류
- 프록시는 포워드 프록시와 리버스 프록시로 나뉘어짐
- 포워드 프록시: 클라이언트 사이드
- 리버스 프록시: 서버 사이드

#### 포워드 프록시 Forward Proxy
- 클라이언트 대신 목적 서버에 통신해주는 구성
- 포워드 프록시의 경우 프록시 서버가 외부 Web 서버와 통신을 수행
- 따라서 클라이언트는 프록시 서버만을 통해서 정보를 얻게 됨
- Web 서버쪽에서는 프록시 서버를 통한 액세스 로그만 남음
- 장점
    - 캐시 저장: 액세스 속도 향상
    - URL 필터링: 외부로 액세스할 때 프록시 서버를 경유하므로 사용자 전원의 외부 액세스 필터링 가능 ex)특정 사이트 블락

#### 리버스 프록시 Reverse Proxy
- Web 서버쪽에 위치하여 클라이언트의 접근을 최초로 받아 리퀘스트에 해당하는 Web 서버에 배분해주는 역할
- 장점
    - 캐시 저장: 포워드 프록시와 마찬가지로 동일한 요청에 대해 캐싱해 둔 값 리턴
    - 보안성: 프록시 서버 내에 시큐리티 대책, 바이러스 대첵을 구현하여 Web 서버의 보안성 강화
    - 부하 분산: 프록시 설정으로 정적 콘텐츠와 동적 콘텐츠의 처리를 분산해 메모리를 효율적으로 사용 -> 로드 밸런스와 병용하면 더욱 효율적 분산 가능
 

# 로드밸런싱

## 로드밸런싱이란?
- 여러 서버에 부하를(workload) 분산시켜 퍼포먼스와 신뢰성을 향상시키기 위한 인프라서비스
- 컴퓨터, 컴퓨터 클러스터, 네트워크 링크, CPU 또는 디스크 드라이브와 같은 여러 컴퓨팅 리소스에서 작업 부하 분산을 향상
- 로드 밸런싱은 리소스 사용을 최적화하고 처리량을 극대화하며 응답 시간을 최소화하고 단일 리소스의 오버로드를 방지하는 것을 목표로 함
- 보통 멀티 레이어 스위치 또는 DNS 서버 프로세스와 같은 전용 소프트웨어 또는 하드웨어가 사용됨

## 로드 밸런서의 중요 작업
1. 서비스 디스커버리
    - 사용 가능한 서버를 결정
2. 헬스 체킹(Health checking)
    - 서버의 상태를 체크하여 트래픽을 처리할 수 있는지 확인하는 과정
    - 헬스체킹은 일반적으로 두 가지 범주로 나뉜다
        - 활성: 주기적인 간격으로 상태 측정 (ex. HTTL 요청을 /healthcheck 엔드포인트에 전송)
        - 수동: 주 데이터 플로우에서 상태 감지 (ex. L4 로드밸런서는 연속 3개의 연결 오류가 있는 경우 서버가 비정상이라고 결정)
3. 로드 밸런싱(Load Balancing)
4. 고정 세션(Sticky sessions)
    - 즉 같은 세션의 요청을 같은 백엔드 서버에 도달하게 하는 것
    - 캐싱, 일시적인 복합구성상태 등과 관련
    - 한편, 세션의 고착도는 본질적으로 취약하므로 시스템 설계시 주의
5. TLS 종료(TLS termination)
    - *TLS(=Transport Layer Security)
        - 전송계층보안.
        - 웹 정보를 암호화해서 송수신하여 개인정보와 무결성을 제공하는 보안 프로토콜
        - SSL(Secure Sockets Layer)에 기반하여 더욱 향상된 프로토콜
6. 관측성(Observability)
7. 보안 및 Dos 완화
8. 환경설정 및 컨트롤 플레인

## 로드 밸런서의 장점
- 네이밍 추상화
    - 클라이언트는 모든 서버를 알 필요 없이, 로드밸런서를 통해 이름을 확인(name resolution)
- 장애 허용
    - 헬스체크 및 다양한 알고리즘을 통해 불량 또는 과부하 상태의 서버를 효과적으로 라우팅
- 비용 및 성능상의 이점        

## 로드 밸런서 종류
- OSI 7 계층에 따라 L1 로드밸런서부터 L7 로드밸런서까지 존재
- L4 로드밸런서부터 포트 정보를 바탕으로 로드를 분산하는 것이 가능하므로 L4, L7이 가장 많이 활용
- 한 대의 서버에 다수의 서버 프로그램을 운영하는 경우 최소 L4 이상의 로드밸런서를 사용

#### L4 로드밸런서
- 네트워크 계층(IP)이나 전송계층(TCP, UDP)의 정보를 바탕으로 로드 분산
- IP 주소, 포트번호, Mac 주소, 전송 프로토콜에 따라 로드 분산
- 장점
    - 데이터를 확인하지 않고 패킷레벨에서만 로드 분산 -> 빠르고 효율적
    - 데이터의 내용을 복호화할 필요 없음 -> 안전, 저렴
- 단점
    - 섬세한 라우팅 불가
    - 사용자의 IP가 수시로 바뀌는 경우 연속적인 서비스 제공 불가    

#### L7 로드밸런서
- 애플리케이션 계층(HTTP, FTP, SMTP)에서 로드 분산
- HTTP 헤더, 쿠키 등과 같은 사용자 요청을 기준으로 특정 서버에 트래픽 분산 가능
- 즉, 패킷의 내용을 확인하고, 그 내용에 따라 로드를 분산 가능
- 장점
    - 클라이언트의 요청을 보다 세분화 하여 서버에 전달
    - 캐싱 기능 제공
    - DDOS 같은 비정상 트래픽을 필터링 가능
- 단점
    - 패킷 내용을 복호화 -> 높은 비용
    - 클라이언트와 로드밸런서가 인증서 공유 -> 보안상의 위험


## 로드 밸런싱 알고리즘

#### 라운드 로빈 방식 Round Robin, RR
- 서버에 들어온 요청을 순차적으로 배정
- 각 서버가 동일한 스펙을 가지고 있고, 세션이 오래 지속되지 않는 경우에 적합

#### 가중 라운드 로빈 방식 Weighted Round Robin
- 각각의 서버마다 가중치를 매기고 가중치가 높은 서버에 우선적으로 배정
- 각각의 서버의 트래픽 처리 속도가 상이한 경우에 적합

#### IP 해시 방식 IP Hash
- 클라이언트의 IP 주소를 해시 함수를 통해 특정 서버에 매핑
- 사용자가 항상 동일한 서버로 연결되는 것을 보장

#### 최초 연결 방식 Least Connection
- 요청이 들어온 시점에 가장 적은 연결상태를 보이는 서버에 우선적으로 배정
- 서버에 분배된 트래픽이 일정하지 않은 경우 적합

#### 최소 응답시간 방식 Least Response Time
- 서버의 현재 연결 상태와 응답시간을 모두 고려해 트래픽 배분


# 로드밸런서(Load Balancer) vs 리버스 프록시(Reverse Proxy)
- 로드밸런싱 장치와 프록시는 종종 혼용되어 사용됨
- 모든 프록시가 로드밸런서는 아니지만, 대다수는 기본적으로 로드 밸런싱이 가능
- 예를 들어 web server로 자주 이용되는 nginx는 리버스 프록시의 용도로 사용할 수 있지만, upstream이라는 옵션으로 로드밸런싱도 가능

